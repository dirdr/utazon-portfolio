# LEGACY DEPLOYMENT WORKFLOW
# This workflow is kept for parallel Docker/SSH deployment during the migration to Cloudflare Pages.
# Once Cloudflare Pages migration is validated, this workflow can be removed.
# New deployments should use Cloudflare Pages (see cloudflare-pages.yml workflow)

name: cd-pipeline (Legacy Docker Deployment)
on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version specification method"
        required: true
        type: choice
        default: "exact"
        options:
          - exact
          - bump
      version:
        description: "Exact version (e.g., 1.1.7) - used when version_type is 'exact'"
        required: false
        type: string
      bump_type:
        description: "Version bump type - used when version_type is 'bump'"
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Determine version to deploy
        id: version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"

          if [ "$VERSION_TYPE" = "exact" ]; then
            DEPLOY_VERSION="${{ github.event.inputs.version }}"
            if [ -z "$DEPLOY_VERSION" ]; then
              echo "Error: version must be specified when version_type is 'exact'"
              exit 1
            fi
            echo "Using exact version: $DEPLOY_VERSION"
          elif [ "$VERSION_TYPE" = "bump" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            if [ -z "$BUMP_TYPE" ]; then
              echo "Error: bump_type must be specified when version_type is 'bump'"
              exit 1
            fi

            # Get current version from package.json
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "Current version: $CURRENT_VERSION"

            # Parse version into major, minor, patch
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

            # Bump version based on input
            if [ "$BUMP_TYPE" = "major" ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif [ "$BUMP_TYPE" = "minor" ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            elif [ "$BUMP_TYPE" = "patch" ]; then
              PATCH=$((PATCH + 1))
            else
              echo "Invalid bump type: $BUMP_TYPE"
              exit 1
            fi

            DEPLOY_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "Calculated version from bump ($BUMP_TYPE): $DEPLOY_VERSION"
          else
            echo "Invalid version_type: $VERSION_TYPE"
            exit 1
          fi

          echo "version=$DEPLOY_VERSION" >> $GITHUB_OUTPUT
          echo "Final deployment version: $DEPLOY_VERSION"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üöÄ Deploying"
            echo "SSH connection successful!"

            VERSION="${{ steps.version.outputs.version }}"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            APP_NAME="${{ vars.APP_NAME }}"
            BASE_DIR="${{ vars.BASE_DIR }}"
            PROJECT_DIR="$BASE_DIR/$ENVIRONMENT"

            echo "üìã Deployment Configuration:"
            echo "   Version: $VERSION"
            echo "   Environment: $ENVIRONMENT"
            echo "   App Name: $APP_NAME"
            echo "   Project Directory: $PROJECT_DIR"

            cd "$PROJECT_DIR" || { echo "üí• Project directory not found: $PROJECT_DIR"; exit 1; }

            if [ ! -f "docker-compose.yaml" ]; then
              echo "üí• docker-compose.yaml not found in $PROJECT_DIR"
              exit 1
            fi

            if [ ! -f ".env" ]; then
              echo "üí• .env file not found in $PROJECT_DIR"
              exit 1
            fi

            check_image_exists() {
              local image="$1"
              echo "üîç Checking if image exists: $image"
              if docker manifest inspect "$image" > /dev/null 2>&1; then
                echo "‚úÖ Image found: $image"
                return 0
              else
                echo "‚ùå Image not found: $image"
                return 1
              fi
            }

            TARGET_IMAGE="$DOCKER_USERNAME/$APP_NAME:$VERSION"

            if check_image_exists "$TARGET_IMAGE"; then
              echo "üéØ Using specified version: $VERSION"
              DEPLOY_VERSION="$VERSION"
            else
              echo "üí• Specified version not found: $TARGET_IMAGE"
              echo "‚ùå Deployment aborted - image does not exist!"
              exit 1
            fi

            cp ".env" ".env.backup"

            # Update or add IMAGE_VERSION in env file
            if grep -q "^IMAGE_VERSION=" ".env"; then
              sed -i "s/^IMAGE_VERSION=.*/IMAGE_VERSION=$DEPLOY_VERSION/" ".env"
            else
              echo "IMAGE_VERSION=$DEPLOY_VERSION" >> ".env"
            fi

            echo "‚úÖ Updated IMAGE_VERSION to: $DEPLOY_VERSION"
            echo "üìÑ Current .env content:"
            cat .env | grep -E "(IMAGE_VERSION|APP_NAME)" || echo "IMAGE_VERSION=$DEPLOY_VERSION"

            docker-compose ps || true

            docker-compose pull

            echo "üõë Stopping existing containers..."
            docker-compose down utazon-$ENVIRONMENT || true

            echo "üöÄ Starting main application..."
            docker-compose up -d utazon-$ENVIRONMENT

            sleep 5

            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Deployment successful!"
              
              echo "üßπ Cleaning up old images..."
              docker image prune -f
              
              rm -f ".env.backup"
              
            else
              echo "üí• Deployment failed! Rolling back..."
              
              mv ".env.backup" ".env"
              
              docker-compose up -d utazon-$ENVIRONMENT
              
              echo "üìú Error logs:"
              docker-compose logs --tail=50
              
              exit 1
            fi

            echo "=================================="
            echo "üèÅ Deployment completed successfully!"
            echo "üåç Environment: $ENVIRONMENT"
            echo "üè∑Ô∏è  Version: $DEPLOY_VERSION"
            echo "üìÅ Directory: $PROJECT_DIR"
            echo "=================================="
  notification:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get deployed version
        id: deployed_version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"

          if [ "$VERSION_TYPE" = "exact" ]; then
            DEPLOYED_VERSION="${{ github.event.inputs.version }}"
          elif [ "$VERSION_TYPE" = "bump" ]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

            if [ "$BUMP_TYPE" = "major" ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif [ "$BUMP_TYPE" = "minor" ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            elif [ "$BUMP_TYPE" = "patch" ]; then
              PATCH=$((PATCH + 1))
            fi

            DEPLOYED_VERSION="$MAJOR.$MINOR.$PATCH"
          fi

          echo "version=$DEPLOYED_VERSION" >> $GITHUB_OUTPUT

      - name: Send discord notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: "@here The portfolio, with version ${{ steps.deployed_version.outputs.version }} has been deployed to ${{ github.event.inputs.environment }}"
